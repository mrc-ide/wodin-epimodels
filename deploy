#!/usr/bin/env bash
set -eu

# Can do this with SITES=(config/*) but it would pick up any file
# there too. This is the main thing to configure when adding a new
# site (or removing one)
SITES=(demo msc-idm-2022 malawi-idm-2022)

# Configure branches here
NETWORK=epimodels
APP_BRANCH=main
API_BRANCH=main
PROXY_BRANCH=mrc-3897

# Nothing to change below here!
REDIS="--redis-url=redis://wodin-redis:6379"

if [[ ! -f hostname ]]; then
    echo "Did not find file 'hostname' in current directory"
    exit 1
fi

WODIN_HOST=$(cat hostname)
if [[ $WODIN_HOST == "localhost" ]]; then
    SSL=
    SSL_PORTS=
    PROTOCOL="http"
else
    SSL="--ssl"
    SSL_PORTS="-p 443:443"
    PROTOCOL="https"
fi

docker rm --force $(docker ps -qa -f 'name=wodin-') 2> /dev/null || /bin/true
docker network create $NETWORK 2> /dev/null || /bin/true
docker volume create redis-docker

docker pull mrcide/odin.api:$API_BRANCH
docker pull mrcide/wodin:$APP_BRANCH
docker pull mrcide/wodin-proxy:$PROXY_BRANCH

# Shared:
docker run -d --name wodin-redis -v redis-data:/data --network=$NETWORK redis:6
docker run -d --name wodin-api --network=$NETWORK \
       mrcide/odin.api:$API_BRANCH

PROXY_SITE_ARG=""
for SITE in "${SITES[@]}"; do
    echo "Bringing up $SITE"
    docker run -d --name "wodin-$SITE" --network=$NETWORK \
           -v $PWD/config/$SITE:/wodin/config:ro \
           mrcide/wodin:$APP_BRANCH \
           --redis-url=redis://wodin-redis:6379 \
           --base-url=$PROTOCOL://$WODIN_HOST/$SITE /wodin/config
    PROXY_SITE_ARG+="--site $SITE=wodin-$SITE:3000 "
done

docker run  -d --network $NETWORK --name wodin-proxy \
       -p 80:80 $SSL_PORTS \
       -v $PWD/root:/wodin/root:ro \
       mrcide/wodin-proxy:$PROXY_BRANCH \
       $WODIN_HOST $SSL $PROXY_SITE_ARG

if [[ $WODIN_HOST == "localhost" ]]; then
    echo "Not copying certificates, using http only"
else
    echo "Copying certificates"
    docker cp ssl/certificate.pem wodin-proxy:/run/proxy/
    docker cp ssl/key.pem wodin-proxy:/run/proxy/
fi

echo "Done, wodin should now be available at $PROTOCOL://$WODIN_HOST"
